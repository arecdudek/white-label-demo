{% extends "WLAppBundle::layout.html.twig" %}

{% block title %}
{{ product.title|raw }}  - White Label Nokaut.pl
{% endblock %}

{% block desc %}
{{ product.description|raw|truncate(150) }}
{% endblock %}

{% block head %}
    {{ parent() }}

    <link rel="canonical" href="{{ url('product', {'productUrl': product.url|trim('/')}) }}" />
{% endblock %}



{% block content %}

    <div class="row product product-details">
        <div class="col-md-4 col-sm-12 gallery">

            <ul class="bxslider gallery-view">
                {% for photoId in product.photoIds if photoId %}
                    {% if loop.index < 11 %}
                    <li><img class="img-responsive" src="{{ nokaut_img_domain ~ nokaut_photo_url.prepare(photoId, '500x500', product.title) }}" alt="{{ product.title }}"></li>
                    {% endif %}
                {% endfor %}
            </ul>

            <div id="gallery-items" class="row gallery-items">
                {% for photoId in product.photoIds if photoId %}
                    {% if loop.index < 11 %}
                        <div class="col-lg-3 col-md-4 col-sm-2 col-xs-3 gallery-item"><a data-slide-index="{{ loop.index0 }}" href=""><img class="img-responsive" src="{{ nokaut_img_domain ~ nokaut_photo_url.prepare(photoId, '90x90', product.title) }}" /></a></div>
                    {% endif %}
                {% endfor %}
            </div>


        </div>
        <div class="col-md-8 col-sm-12">
            <div class="row">
                <div class="col-md-8 col-sm-12">
                    <h1 class="price">{{ product.title|raw }}
                        <small class="stars">Ocena produktu:
                            {% for i in 1..5 %}
                                {% if product.rating and product.rating.rating >= i %}
                                    <i class="product-star fa fa-star" data-star-current="{{ product.rating ? product.rating.rating|round : 0 }}" data-star-nr="{{ i }}"></i>
                                {% elseif product.rating and product.rating.rating|round >= i %}
                                    <i class="product-star fa fa-star-half-o" data-star-current="{{ product.rating ? product.rating.rating|round : 0 }}" data-star-nr="{{ i }}"></i>
                                {% else %}
                                    <i class="product-star fa fa-star-o" data-star-current="{{ product.rating ? product.rating.rating|round : 0 }}" data-star-nr="{{ i }}"></i>
                                {% endif %}
                            {% endfor %}
                        </small>
                    </h1>
                </div>
                <div class="col-md-4 col-sm-12 text-right">
                    <p class="lead price big"><small>od </small>{{ offers.metadata.priceMin|number_format(2, ',', '') }} PLN</p>
                    {% set savePercent = helper_price.getSavePercent(product.prices) %}
                    {% if savePercent > 0 %}
                        <p class="price"><small>oszczędzasz do</small> {{ savePercent }}%</p>
                    {% endif %}
                </div>
                <div class="col-md-12 col-sm-12">
                    <ul class="features">
                        <li>Producent: <em>{{ product.producerName|raw }}</em></li>
                        <li>Kategoria: <em>{{ category.title|raw }}</em></li>
                        {% for property in product.properties %}
                            <li>{{ property.name|raw }}:
                                <em>{% include '@WLApp/Product/property.html.twig' %}</em>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <ul class="nav nav-tabs">
                <li class="active"><a href="#offers" data-toggle="tab">Oferty ({{ offers.metadata.total }})</a></li>
                <li><a href="#desc" data-toggle="tab">Opis produktu</a></li>

            </ul>
            <div class="tab-content">
                <div class="tab-pane fade active in" id="offers">

                    <div class="row pull-right options">
                        <div class="col-md-12 col-sm-12">
                            <div class="btn-group">
                                <a href="#" class="btn btn-link dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-bars"></i>
                                </a>
                                <ul id="sortOffersSelect" class="dropdown-menu dropdown-menu-right">
                                    <li class="dropdown-header">Sortowanie</li>
                                    <li class="active"><a href="#domyslne"><i class="fa fa-long-arrow-down"></i> domyślne</a></li>
                                    <li><a href="#najtansze"><i class="fa fa-sort-numeric-asc"></i> od najtańszych</a></li>
                                    <li><a href="#najdrozsze"><i class="fa fa-sort-numeric-desc"></i> od najdroższych</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="offersContainer" class="row offers">
                        {% for offer in offers %}
                        <!-- offer starts here -->
                        <div class="col-sm-12 offer" data-lp="{{ loop.index }}" data-price="{{ offer.price|number_format(2, '.', '') }}">
                            <a rel="nofollow" target="_blank" href="{{ offer|click }}">
                                <div class="row">
                                    <div class="col-xs-4 col-sm-2">
                                        <div class="image">
                                            <img src="{{ nokaut_img_domain ~ nokaut_photo_url.prepare(offer.photoId, '90x90', offer.title) }}" />
                                        </div>
                                    </div>
                                    <div class="col-xs-8 col-sm-7">
                                        <h5>{{ offer.title|raw }}</h5>
                                        <div class="pull-right">
                                            <small class="stars">
                                                Ocena sklepu:
                                                {% for i in 1..5 %}
                                                    {% if offer.shop.opineoRating and (offer.shop.opineoRating.rating/2) >= i %}
                                                        <i class="fa fa-star"></i>
                                                    {% elseif offer.shop.opineoRating and (offer.shop.opineoRating.rating/2)|round >= i %}
                                                        <i class="fa fa-star-half-o"></i>
                                                    {% else %}
                                                        <i class="fa fa-star-o"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </small>
                                            <img src="{{ nokaut_img_domain ~ offer.shop.urlLogo }}" />
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-sm-3 text-right">
                                        <p class="lead price">{{ offer.price|number_format(2, ',', '') }} PLN</p>
                                        <span class="btn btn-success btn-success-outlined btn-icon-right">Zobacz w sklepie <i class="fa fa-angle-right"></i></span>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <!-- offer ends here -->
                        {% endfor %}
                    </div>
                </div>
                <div class="tab-pane fade" id="desc">
                    {{ product.descriptionHtml|raw }}
                </div>
            </div>

        </div>
    </div>


    <div class="row lower-double products">
        <div class="col-xs-8">
            <h4>Produkty podobne</h4>
        </div>
        <div class="col-xs-4 text-right">
            <a id="products-similar-prev" class="btn btn-sm btn-primary btn-primary-outlined"><i class="fa fa-angle-left"></i></a>
            <a id="products-similar-next" class="btn btn-sm btn-primary btn-primary-outlined"><i class="fa fa-angle-right"></i></a>
        </div>
    </div>
    <div class="row">
    <div id="products-similar" class=" owl-carousel">
        {% for product in productsSimilar %}
            {% include '@WLApp/Product/productBox.html.twig' with {'product': product} %}
        {% endfor %}
    </div>
    </div>




    <div class="row lower-double products">
        <div class="col-xs-8">
            <h4>Produkty najpopularniejsze w kategorii <a href="{{ url('category', {'categoryUrlWithFilters': category.url|trim('/')}) }}">{{ category.title|raw }}</a></h4>
        </div>
        <div class="col-xs-4 text-right">
            <a id="products-top-prev" class="btn btn-sm btn-primary btn-primary-outlined"><i class="fa fa-angle-left"></i></a>
            <a id="products-top-next" class="btn btn-sm btn-primary btn-primary-outlined"><i class="fa fa-angle-right"></i></a>
        </div>
    </div>
    <div class="row">
    <div id="products-top" class=" owl-carousel">
    {% for product in productsTop10 %}
        {% include '@WLApp/Product/productBox.html.twig' with {'product': product} %}
    {% endfor %}
    </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="{{ asset('bundles/wlapp/js/isotope.pkgd.min.js') }}"></script>

    <script type="text/javascript">
        $('#offersContainer').isotope({
            itemSelector : '.offer',
            layoutMode : 'fitRows',
            getSortData : {
                price : function ( $elem ) {
                    return parseFloat($($elem).attr('data-price'));
                }
            }
        });

        $('#sortOffersSelect a').click(function(){
            // get href attribute, minus the '#'
            var sortName = $(this).attr('href').slice(1);
            switch (sortName) {
                case 'domyslne':
                    $('#offersContainer').isotope({ sortBy : 'original-order' });
                    break;
                case 'najtansze':
                    $('#offersContainer').isotope({
                        sortBy : 'price',
                        sortAscending : true
                    });
                    break;
                case 'najdrozsze':
                    $('#offersContainer').isotope({
                        sortBy : 'price',
                        sortAscending : false
                    });
                    break;
            }
            $('#sortOffersSelect li').removeClass('active');
            $(this).parent().addClass('active');
            $('#sortOffersSelect').dropdown('toggle');
            return false;
        });


    </script>

    {% if canAddRating %}
    <script type="text/javascript">

        $('.product-star').css('cursor', 'pointer');
        $('.product-star')
        .mouseover(function(e) {
            var rating = calculateRating(e, this);
            selectStars(rating);
        }).mouseout(function(e) {
            var currentRating = $(this).attr('data-star-current');
            selectStars(currentRating);
        }).click(function(e) {
            sendPostWithRating(e, this);
        });

        function calculateRating(e, elementRating) {
            return $(elementRating).attr('data-star-nr');
        }

        function sendPostWithRating(e, elementStars) {
            var rating = calculateRating(e, elementStars);
            $.post("{{ url('rating_add') }}",
                    {
                        productId: $('#productRating').attr('data-product'),
                        rating: rating
                    })
                    .done(function (data) {
                        if (data != -1) {
                            selectStars(Math.round(data));
                            $(".product-star").unbind().css('cursor','default');
                            alert('Dziękujemy za dodanie oceny')
                        } else {
                            alert('Nie można dodać oceny. Proszę spróbować później');
                        }
                    });
        }

        function selectStars(countSelectedStars) {
            $('.product-star').removeClass('fa-star','silver');
            $('.product-star').addClass('fa-star-o','silver');
            for(var i=1; i<=countSelectedStars; ++i) {
                $('.product-star[data-star-nr='+i+']').removeClass('fa-star-o','silver');
                $('.product-star[data-star-nr='+i+']').addClass('fa-star','silver');
            }
        }
    </script>
    {% endif %}
{% endblock %}